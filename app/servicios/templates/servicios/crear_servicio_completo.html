{% extends 'base.html' %}

{% block title %}Crear Servicio Completo{% endblock %}

{% block content %}
<h1 class="h3 my-4 text-underline">Crear Servicio Completo</h1>

<form action="{{ url_for('servicios.crear_completo') }}" method="POST" enctype="multipart/form-data" class="shadow p-4 rounded">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

  <!-- Título de publicación -->
  <div class="mb-3">
    <label for="titulo_publicacion" class="form-label">Título de Publicación</label>
    <input type="text" name="titulo_publicacion" id="titulo_publicacion" class="form-control" required>
  </div>

  <!-- Estado -->
  <div class="mb-3">
    <label for="estado" class="form-label">Estado</label>
    <select name="estado" id="estado" class="form-select">
      <option value="Activo" selected>Activo</option>
      <option value="Inactivo">Inactivo</option>
    </select>
  </div>

  <!-- Tipo de Servicio -->
  <div class="mb-3">
    <label for="tipo_servicio_id" class="form-label">Tipo de Servicio</label>
    <select name="tipo_servicio_id" id="tipo_servicio_id" class="form-select">
      <option value="" disabled selected>— Selecciona un tipo —</option>
      {% for ts in tipos_servicio %}
        <option value="{{ ts.id_tipo_servicio }}">{{ ts.nombre_servicio }}</option>
      {% endfor %}
    </select>
  </div>


  <div class="mb-4">
    <label class="form-label">Locales disponibles</label>
    <div>
      {% if locales %}
        {% for loc in locales %}
          <div class="form-check">
            <input class="form-check-input"
                   type="checkbox"
                   name="locales[]"                   
                   value="{{ loc.id }}"
                   id="loc{{ loc.id }}">
            <label class="form-check-label" for="loc{{ loc.id }}">
              {{ loc.direccion }}
            </label>
          </div>
        {% endfor %}
      {% else %}
        <div class="alert alert-warning">
          No tienes locales registrados. 
          <a href="#">Agregar local</a>  
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Imagen principal -->
  <div class="mb-3">
    <label for="imagen" class="form-label">Imagen Principal</label>
    <input type="file" name="imagen" id="imagen" class="form-control">
    <div id="previewImagen" class="mt-2"></div>
  </div>

  <!-- Subtítulo 1 -->
  <div class="mb-3">
    <label for="subtitulo1" class="form-label">Subtítulo 1</label>
    <textarea name="subtitulo1" id="subtitulo1" class="form-control" rows="2"></textarea>
  </div>

  <!-- Descripción 1 -->
  <div class="mb-3">
    <label for="descripcion1" class="form-label">Descripción 1</label>
    <textarea name="descripcion1" id="descripcion1" class="form-control" rows="4"></textarea>
  </div>

  <!-- Subtítulo 2 -->
  <div class="mb-3">
    <label for="subtitulo2" class="form-label">Subtítulo 2</label>
    <textarea name="subtitulo2" id="subtitulo2" class="form-control" rows="2"></textarea>
  </div>

  <!-- Descripción 2 -->
  <div class="mb-3">
    <label for="descripcion2" class="form-label">Descripción 2</label>
    <textarea name="descripcion2" id="descripcion2" class="form-control" rows="4"></textarea>
  </div>

  <!-- Media 1 -->
  <div class="mb-3">
    <label class="form-label">Adjuntar Imagen/Video 1</label>
    <select id="tipoMedio1" class="form-select mb-2" name="tipo_medio1">
      <option value="imagen" selected>Imagen</option>
      <option value="video">Video (YouTube URL)</option>
    </select>
    <input type="file" name="media1_imagen" id="media1Imagen" class="form-control">
    <input type="text" name="media1_video_url" id="media1Video" class="form-control" placeholder="https://youtu.be/..." style="display:none;">
    <div id="preview1" class="mt-2"></div>
  </div>

  <!-- Subtítulo 3 -->
  <div class="mb-3">
    <label for="subtitulo3" class="form-label">Subtítulo 3</label>
    <textarea name="subtitulo3" id="subtitulo3" class="form-control" rows="2"></textarea>
  </div>

  <!-- Descripción 3 -->
  <div class="mb-3">
    <label for="descripcion3" class="form-label">Descripción 3</label>
    <textarea name="descripcion3" id="descripcion3" class="form-control" rows="4"></textarea>
  </div>

  <!-- Media 2 -->
  <div class="mb-3">
    <label class="form-label">Adjuntar Imagen/Video 2</label>
    <select id="tipoMedio2" class="form-select mb-2" name="tipo_medio2"> 
      <option value="imagen" selected>Imagen</option>
      <option value="video">Video (YouTube URL)</option>
    </select>
    <input type="file" name="media2_imagen" id="media2Imagen" class="form-control">
    <input type="text" name="media2_video_url" id="media2Video" class="form-control" placeholder="https://youtu.be/..." style="display:none;">
    <div id="preview2" class="mt-2"></div>
  </div>

  <!-- ...campos anteriores... -->

<!-- Precio -->
<div class="mb-3">
  <label for="precio" class="form-label">Precio</label>
  <input type="number" name="precio" id="precio" step="0.01" class="form-control" required>
</div>
            <!-- Tipo de Oferta -->
<div class="mb-3">
  <label for="tipo_oferta" class="form-label">Tipo de oferta</label>
  <select name="tipo_oferta" id="tipo_oferta" class="form-select" required>
    <option value="Oferta"  selected>Oferta (precio fijo)</option>
    <option value="Descuento">Descuento (%)</option>
    <option value="2x1">2 × 1</option>
  </select>
</div>

<!-- % de descuento (solo visible si se elige Descuento) -->
<div class="mb-3" id="grupoPorcentaje" style="display:none;">
  <label for="porcentaje_descuento" class="form-label">Porcentaje de descuento</label>
  <input type="number" min="1" max="100" step="1"
         name="porcentaje_descuento" id="porcentaje_descuento"
         class="form-control">
</div>
<!-- Precio Oferta -->
<div class="mb-3">
  <label for="precio_oferta" class="form-label">Precio Oferta</label>
  <input type="number" name="precio_oferta" id="precio_oferta" step="0.01" class="form-control">
</div>



    <!-- Precio Promoción (%) -->
<div class="mb-3">
  <label for="precio_promocion" class="form-label">Reserva (%)</label>
  <select name="precio_promocion" id="precio_promocion" class="form-select">
    {% for pct in range(0, 110, 10) %}
      <option value="{{ pct }}" {% if servicio and servicio.precio_promocion == pct %}selected{% endif %}>
        {{ pct }}%
      </option>
    {% endfor %}
  </select>
</div>



<!-- Tiempo de Duración -->
<div class="mb-3">
  <label for="tiempo_duracion" class="form-label">Tiempo de duración (ej: 2 horas, 30 min, etc.)</label>
  <input type="text" name="tiempo_duracion" id="tiempo_duracion" class="form-control"
         value="{{ servicio.tiempo_duracion if servicio else '' }}">
</div>

<!-- En venta -->
<div class="mb-3">
  <label class="form-label">¿En venta?</label>
  <select name="en_venta" id="en_venta" class="form-select">
      <option value="1" selected>Sí</option>
      <option value="0">No</option>
  </select>
</div>


  <button type="submit" class="btn btn-success">Guardar Servicio Completo</button>
</form>

<script>
  // Preview de imagen principal
  document.getElementById('imagen').addEventListener('change', function(){
    const file = this.files[0], pr = document.getElementById('previewImagen');
    pr.innerHTML = '';
    if (file) {
      const reader = new FileReader();
      reader.onload = e => pr.innerHTML = `<img src="${e.target.result}" class="img-thumbnail" style="max-width:200px;">`;
      reader.readAsDataURL(file);
    }
  });

  // Previews para media1 y media2
  function previewImagen(input, previewDiv){
    const f = input.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = e => previewDiv.innerHTML = `<img src="${e.target.result}" class="img-thumbnail" style="max-width:200px;">`;
    r.readAsDataURL(f);
  }

  function previewYouTube(input, previewDiv){
    const m = input.value.match(/(?:youtu\.be\/|v=)([^&]+)/);
    previewDiv.innerHTML = m
      ? `<iframe width="300" height="169" src="https://www.youtube.com/embed/${m[1]}" frameborder="0" allowfullscreen></iframe>`
      : `<small class="text-danger">URL inválida</small>`;
  }

  ['1','2'].forEach(i => {
    document.getElementById(`tipoMedio${i}`).addEventListener('change', e => {
      const vid = document.getElementById(`media${i}Video`),
            img = document.getElementById(`media${i}Imagen`);
      document.getElementById(`preview${i}`).innerHTML = '';
      if (e.target.value === 'video') {
        img.style.display = 'none'; vid.style.display = 'block';
      } else {
        vid.style.display = 'none'; img.style.display = 'block';
      }
    });
    document.getElementById(`media${i}Imagen`).addEventListener('change', ()=>
      previewImagen(document.getElementById(`media${i}Imagen`), document.getElementById(`preview${i}`))
    );
    document.getElementById(`media${i}Video`).addEventListener('input', ()=>
      previewYouTube(document.getElementById(`media${i}Video`), document.getElementById(`preview${i}`))
    );
  });

  // TinyMCE Editor
  tinymce.init({
    selector: '#subtitulo1, #descripcion1, #subtitulo2, #descripcion2, #subtitulo3, #descripcion3',
    height: 200,
    menubar: false,
    plugins: 'link lists textcolor',
    toolbar: 'undo redo | bold italic underline | alignleft aligncenter alignright | forecolor backcolor | bullist numlist',
    branding: false
  });

  function recalcularDescuento() {
  const precio    = parseFloat(document.getElementById('precio').value || 0);
  const pctInput  = document.getElementById('porcentaje_descuento');
  const pct       = parseFloat(pctInput.value || 0);
  const campoOferta = document.getElementById('precio_oferta');

  if (!isNaN(precio) && !isNaN(pct)) {
    const nuevo = (precio - (precio * pct / 100)).toFixed(2);
    campoOferta.value = nuevo;
  }
}

function aplicarTipoOferta() {
  const tipo = document.getElementById('tipo_oferta').value;
  const grpPct = document.getElementById('grupoPorcentaje');
  const campoOferta = document.getElementById('precio_oferta');

  if (tipo === 'Descuento') {
    grpPct.style.display = 'block';
    campoOferta.readOnly = true;          // cálculo automático
    recalcularDescuento();
  } else if (tipo === '2x1') {
    grpPct.style.display = 'none';
    campoOferta.readOnly = true;
    const precio = parseFloat(document.getElementById('precio').value || 0);
    campoOferta.value = precio.toFixed(2); // mismo precio
  } else { // Oferta
    grpPct.style.display = 'none';
    campoOferta.readOnly = false;         // libre edición
    campoOferta.value = '';
  }
}

document.getElementById('tipo_oferta').addEventListener('change', aplicarTipoOferta);
document.getElementById('precio').addEventListener('input', aplicarTipoOferta);
document.getElementById('porcentaje_descuento').addEventListener('input', recalcularDescuento);

// disparo inicial
aplicarTipoOferta();

</script>
{% endblock %}
