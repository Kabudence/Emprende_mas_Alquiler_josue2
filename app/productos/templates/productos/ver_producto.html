{% extends "base.html" %}

{% block title %}Ver Producto{% endblock %}

{% block content %}

<h1 class="h3 my-4">Ver Producto</h1>

<div class="card shadow-sm">
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-6">
                <div class="product-images">
                    {% if producto.detalles %}
                        <!-- Mostrar la imagen principal (la primera de la lista) -->
                        <img id="mainImage" src="{{ url_for('static', filename='uploads/' + producto.detalles[0].imagen) }}" class="img-fluid mb-4" alt="Imagen del producto" style="width: 100%; max-width: 300px; height: auto;">
                    {% else %}
                        <p>No hay imágenes disponibles.</p>
                    {% endif %}
                    
                    <div class="product-thumbnails">
                        {% for detalle in producto.detalles %}
                            <!-- Mostrar miniaturas de imágenes de colores únicos -->
                            <img src="{{ url_for('static', filename='uploads/' + detalle.imagen) }}" class="img-thumbnail" alt="Detalle del producto" style="width: 100px; margin-right: 10px; cursor: pointer;" onclick="changeMainImage(this)">
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <h2>{{ producto.nombre }}</h2>
                <p><strong>Descripción:</strong> {{ producto.descripcion if producto.descripcion else "No disponible." }}</p>
                
                <div class="mt-4">
                    <h5>Seleccione Color:</h5>
                    <select id="colorSelect" class="form-select mb-3" onchange="updateProductDetails()">
                        <option selected disabled>Seleccione un color</option>
                        {% for detalle in producto.detalles %}
                            <option value="{{ detalle.color.nombre }}" data-color="{{ detalle.color.hexadecimal }}">{{ detalle.color.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mt-4">
                    <h5>Seleccione Capacidad:</h5>
                    <select id="capacitySelect" class="form-select mb-3" onchange="updatePriceAndStock()">
                        <option selected disabled>Seleccione una capacidad</option>
                    </select>
                </div>

                <div class="mt-4">
                    <h5 id="priceHeader">Precio: S/. <span id="priceDisplay">-</span></h5>
                    <h5 id="stockHeader">Stock: <span id="stockDisplay">-</span> unidades</h5>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let capacidades = {};  // Para almacenar las capacidades con precio y stock

    async function updateProductDetails() {
        const colorSelect = document.getElementById("colorSelect");
        const capacitySelect = document.getElementById("capacitySelect");

        // Llamamos a la nueva ruta para obtener las capacidades basadas en el color
        const response = await fetch(`/productos/capacidades/{{ producto.id }}?color=${colorSelect.value}`);
        capacidades = await response.json();

        // Limpiamos las capacidades previas y agregamos las nuevas capacidades
        capacitySelect.innerHTML = '<option selected disabled>Seleccione una capacidad</option>';
        for (const capacidad in capacidades) {
            const option = document.createElement("option");
            option.value = capacidad;
            option.innerText = capacidad;
            capacitySelect.appendChild(option);
        }

        // Reiniciamos precio y stock
        document.getElementById("priceDisplay").innerText = "-";
        document.getElementById("stockDisplay").innerText = "-";

        // Habilitamos el selector de capacidad si se ha seleccionado un color
        if (colorSelect.value) {
            capacitySelect.disabled = false;
        } else {
            capacitySelect.disabled = true;
        }
    }

    function updatePriceAndStock() {
        const colorSelect = document.getElementById("colorSelect");
        const capacitySelect = document.getElementById("capacitySelect");

        const selectedCapacity = capacitySelect.value;
        const priceDisplay = document.getElementById("priceDisplay");
        const stockDisplay = document.getElementById("stockDisplay");

        if (selectedCapacity && capacidades[selectedCapacity]) {
            const { precio, stock } = capacidades[selectedCapacity];
            priceDisplay.innerText = precio ? precio : "-";
            stockDisplay.innerText = stock ? stock : "-";
        }
    }

    function changeMainImage(image) {
        document.getElementById("mainImage").src = image.src;
    }
</script>

{% endblock %}
