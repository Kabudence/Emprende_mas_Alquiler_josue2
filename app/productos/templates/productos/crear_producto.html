{% extends 'base.html' %}

{% block title %}Crear Producto{% endblock %}

{% block content %}
<h1 class="h3 my-4 text-underline">Crear un Nuevo Producto</h1>

<div class="card shadow-sm">
    <div class="card-body">
        <form action="{{ url_for('productos.crear') }}" method="POST" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="nombre" class="form-label">Nombre del Producto</label>
                <input type="text" class="form-control" id="nombre" name="nombre" placeholder="Ingrese el nombre del producto" required>
            </div>
            <div class="mb-3">
                <label for="precio" class="form-label">Precio</label>
                <input type="number" step="0.01" class="form-control" id="precio" name="precio" placeholder="Ingrese el precio del producto" required>
            </div>
            <div class="mb-3">
                <label for="descripcion" class="form-label">Descripción</label>
                <textarea class="form-control" id="descripcion" name="descripcion" rows="3" placeholder="Ingrese la descripción del producto"></textarea>
            </div>
            <div class="mb-3">
                <label for="categoria" class="form-label">Categoría</label>
                <select class="form-select" id="categoria" name="categoria_id" onchange="loadSizes()" required>
                    <option selected disabled>Seleccione una categoría</option>
                    {% for categoria in categorias %}
                    <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                    {% endfor %}
                </select>
            </div>

            <h3>Atributos</h3>
            <div id="attributes-container">
                <!-- Tamaños y variantes dinámicos se añadirán aquí -->
            </div>
            <button type="button" class="btn btn-primary mb-3" onclick="addSize()">Agregar Tamaño</button>

            <div class="text-end">
                <button type="submit" class="btn btn-success">Registrar Producto</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Vista Previa de Imagen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body d-flex justify-content-center">
                <img id="modalImage" src="" class="img-fluid" alt="Vista Previa">
            </div>
        </div>
    </div>
</div>

<script>
    let sizes = [];
    let availableSizes = {};
    const availableColors = JSON.parse('{{ colores|tojson }}');

    function loadSizes() {
        const categoriaId = document.getElementById('categoria').value;

        fetch(`/productos/tamanios_por_categoria/${categoriaId}`)
            .then(response => response.json())
            .then(data => {
                availableSizes = data.reduce((acc, item) => {
                    acc[item.id] = item.nombre;
                    return acc;
                }, {});
                sizes = [];
                renderSizes();
            });
    }

    function addSize() {
        sizes.push({ size: '', variants: [] });
        renderSizes();
    }

    function removeSize(index) {
        sizes.splice(index, 1);
        renderSizes();
    }

    function updateSize(index, value) {
        sizes[index].size = value;
    }

    function addVariant(sizeIndex) {
        if (sizes[sizeIndex].variants.length >= 3) {
            alert('Solo se permiten 3 variantes por tamaño.');
            return;
        }
        sizes[sizeIndex].variants.push({ color: '', stock: '', image: '' });
        renderSizes();
    }

    function removeVariant(sizeIndex, variantIndex) {
        sizes[sizeIndex].variants.splice(variantIndex, 1);
        renderSizes();
    }

    function updateVariant(sizeIndex, variantIndex, field, value) {
        sizes[sizeIndex].variants[variantIndex][field] = value;
    }

    function renderSizes() {
        const container = document.getElementById('attributes-container');
        container.innerHTML = '';

        sizes.forEach((size, sizeIndex) => {
            const sizeBlock = document.createElement('div');
            sizeBlock.className = 'mb-4 p-3 border rounded';
            sizeBlock.innerHTML = `
                <div class="d-flex justify-content-between">
                    <h4>Tamaño</h4>
                    <button type="button" class="btn-close" aria-label="Close" onclick="removeSize(${sizeIndex})"></button>
                </div>
                <div class="mb-3">
                    <select class="form-select" name="size_${sizeIndex + 1}" onchange="updateSize(${sizeIndex}, this.value)" required>
                        <option selected disabled>Seleccione un tamaño</option>
                        ${Object.entries(availableSizes).map(([id, name]) => `
                            <option value="${id}" ${size.size === id ? 'selected' : ''}>${name}</option>
                        `).join('')}
                    </select>
                </div>
                <h5>Colores y Variantes</h5>
                <div id="variants-${sizeIndex}" class="row gx-3">
                </div>
                <button type="button" class="btn btn-secondary mt-2" onclick="addVariant(${sizeIndex})">Agregar Variante</button>
            `;
            const variantsContainer = sizeBlock.querySelector(`#variants-${sizeIndex}`);
            size.variants.forEach((variant, variantIndex) => {
                const variantBlock = document.createElement('div');
                variantBlock.className = 'col-md-4 p-2';
                variantBlock.innerHTML = `
                    <div class="border rounded p-2">
                        <button type="button" class="btn-close float-end" aria-label="Close" onclick="removeVariant(${sizeIndex}, ${variantIndex})"></button>
                        <div class="mb-2">
                            <label class="form-label">Color:</label>
                            <select class="form-select" name="color_${sizeIndex + 1}_${variantIndex + 1}" onchange="updateVariant(${sizeIndex}, ${variantIndex}, 'color', this.value)" required>
                                <option selected disabled>Seleccione un color</option>
                                ${availableColors.map(color => `
                                    <option value="${color.id}" ${variant.color === color.id ? 'selected' : ''}>${color.nombre}</option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Stock:</label>
                            <input type="number" class="form-control" name="stock_${sizeIndex + 1}_${variantIndex + 1}" placeholder="Stock" value="${variant.stock || ''}" onchange="updateVariant(${sizeIndex}, ${variantIndex}, 'stock', this.value)" required>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Imagen:</label>
                            <input type="file" class="form-control" name="image_${sizeIndex + 1}_${variantIndex + 1}" accept="image/*">
                        </div>
                    </div>
                `;
                variantsContainer.appendChild(variantBlock);
            });
            container.appendChild(sizeBlock);
        });
    }
</script>
{% endblock %}
