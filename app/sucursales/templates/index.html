{% extends 'base.html' %}

{% block title %}Lista de Sucursales{% endblock %}

{% block content %}
    <div class="container mt-5">
        <h1 class="mb-4">Sucursales</h1>
        <a href="/sucursales/crear" class="btn btn-primary mb-3">Crear Sucursal</a>
        <table class="table table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nombre de Sucursal</th>
                    <th>Distrito</th>
                    <th>Dirección</th>
                    <th>Celular</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for sucursal in sucursales|sort(attribute=6, reverse=True) %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ sucursal[1] }}</td>
                    <td>{{ sucursal[3] }}</td>
                    <td>{{ sucursal[4] }}</td>
                    <td>{{ sucursal[5] }}</td>
                    <td>{{ sucursal[6] }}</td>
                    <td>
                        <a href="/sucursales/editar/{{ sucursal[0] }}" class="btn btn-outline-warning btn-sm btn-edit">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button class="btn btn-outline-danger btn-sm" onclick="confirmarEliminacion('{{ sucursal[0] }}')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function confirmarEliminacion(id) {
            // Si tienes meta csrf-token, úsalo. Si no, deja csrfToken = null
            let csrfToken = null;
            const meta = document.querySelector('meta[name="csrf-token"]');
            if (meta) csrfToken = meta.getAttribute('content');

            Swal.fire({
                title: '¿Estás seguro?',
                text: "Esta acción no se puede deshacer.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/sucursales/eliminar/${id}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...(csrfToken ? {'X-CSRFToken': csrfToken} : {})
                        },
                        body: JSON.stringify({}) // body vacío, puede omitirse pero es estándar
                    })
                    .then(async response => {
                        let data;
                        try { data = await response.json(); } catch { data = {}; }
                        if (response.ok && data.success) {
                            Swal.fire('Eliminado', data.message, 'success').then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire('Error', data.message || 'No se pudo eliminar.', 'error');
                        }
                    })
                    .catch(error => {
                        Swal.fire('Error', 'Ocurrió un error inesperado.', 'error');
                    });
                }
            });
        }
    </script>
{% endblock %}
